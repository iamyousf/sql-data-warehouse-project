/*SCRIPT PURPOSE
This SQL script is used for Exploratory Data Analysis (EDA) on
the Gold layer of the data warehouse to summarize key business metrics, analyze sales performance, and identify patterns
across customers,
products, and categories.*/
USE Datawarehouse;
SELECT * FROM gold.dim_customers
SELECT * FROM gold.dim_products
Select * FROM gold.fact_sales

--Exploring Data Base 

--EXPLORE ALL OBJECTS IN DATABASE
SELECT * FROM INFORMATION_SCHEMA.TABLES

--EXPLORE ALL COLUMNS IN DATABASE
SELECT * FROM INFORMATION_SCHEMA.COLUMNS
WHERE TABLE_NAME='dim_customers'

--EXPLORING DIMENSIONS
SELECT DISTINCT country FROM gold.dim_customers 

SELECT DISTINCT category,subcategory,product_name  FROM gold.dim_products

SELECT DISTINCT product_line FROM gold.dim_products

--EXPLORING DATE
SELECT
MIN(birthdate) AS oldest_person,
DATEDIFF(YEAR,MIN(birthdate),GETDATE()) AS oldest_age,
MAX(birthdate) AS yougest_person,
DATEDIFF(YEAR,MAX(birthdate),GETDATE()) AS oldest_age
FROM  gold.dim_customers

SELECT 
MIN(order_date) AS frsit_order,
MAX(order_date) AS last_order,
DATEDIFF(YEAR,MIN(order_date),MAX(order_date)) AS order_range_years,
DATEDIFF(MONTH,MIN(order_date),MAX(order_date)) AS order_range_months,
DATEDIFF(DAY,MIN(order_date),MAX(order_date)) AS order_range_days
FROM gold.fact_sales

--EXPLORING MEASURE

--FIND THE TOTAL SALES
SELECT SUM(sales_amount) AS total_sales FROM gold.fact_sales
--FIND HOW MANY ITEMS ARE SOLD 
SELECT SUM(quantity) AS total_quantity FROM gold.fact_sales
--FIND AVG OF SELLING PRICE
SELECT AVG(price) AS avg_price FROM gold.fact_sales
--FIND TOTAL NUMBERS OF ORDERS 
SELECT COUNT(order_number) AS total_order FROM gold.fact_sales
SELECT COUNT( DISTINCT order_number) AS total_order FROM gold.fact_sales
--FIND THE TOTAL NUMS OF PRODUCTS
SELECT COUNT(product_key) AS total_products FROM gold.fact_sales
--FIND TOTAL NUMS OF CUSTOMERS
SELECT COUNT(customer_key) AS total_customers FROM gold.dim_customers

--OR WE CAN USE IT IN ONE QUERY 
SELECT 'Total Sales' AS measure_name, SUM(sales_amount) AS measure_value FROM gold.fact_sales
UNION ALL
SELECT 'Total Quantity' AS measure_name, SUM(quantity) AS measure_value FROM gold.fact_sales
UNION ALL
SELECT 'Average Price' AS measure_name, AVG(price) AS measure_value FROM gold.fact_sales
UNION ALL
SELECT 'Total Orders' AS measure_name, COUNT(DISTINCT order_number) AS measure_value FROM gold.fact_sales
UNION ALL
SELECT 'Total Products' AS measure_name, COUNT(product_key) AS measure_value FROM gold.fact_sales
UNION ALL
SELECT 'Total Customers' AS measure_name, COUNT(customer_key) AS measure_value FROM gold.dim_customers


--EXPLORING MAGNITUDE
--FIND TOTAL CUSTOMERS BY COUNTRIES
SELECT
country,
COUNT(customer_key) AS total_customers
FROM gold.dim_customers
GROUP BY country
ORDER BY total_customers DESC
--FIND TOTAL CUSTOMERS BY GENDERS
SELECT
gender,
COUNT(customer_key) AS total_customers
FROM gold.dim_customers
GROUP BY gender
ORDER BY total_customers DESC
--FIND THE TOTAL PRODUCTS BY CATEGORY
SELECT
category,
COUNT(product_key) AS total_products
FROM gold.dim_products
GROUP BY category
ORDER BY total_products DESC
--FIND AVG COST IN EACH CATEGORY
SELECT 
category,
AVG(cost) AS total_cost
FROM gold.dim_products
GROUP BY category
ORDER BY total_cost DESC
--FIND TOTAL REVENUE GENERATED BY EACH CATEGORY
SELECT
p.category,
    COALESCE(SUM(f.sales_amount),0)  AS total_revenue
FROM gold.dim_products p
LEFT JOIN gold.fact_sales f
ON p.product_key=f.product_key
GROUP BY p.category
ORDER BY total_revenue DESC
--FIND REVENUE GENERATED BY EACH CUSTOMERS
SELECT 
c.customer_key,
c.firstname,
c.lastname,
COALESCE(SUM(f.sales_amount),0) AS total_revenue
FROM gold.fact_sales f 
LEFT JOIN gold.dim_customers c
ON c.customer_key=f.customer_id
GROUP BY c.customer_key,
c.firstname,
c.lastname
ORDER BY total_revenue DESC
--FIND DISTRIBUTION SOLD ACROSS EACH COUNTRY 
SELECT 
c.country,
COALESCE(SUM(f.sales_amount),0) AS total_revenue
FROM gold.fact_sales f 
LEFT JOIN gold.dim_customers c
ON c.customer_key=f.customer_id
GROUP BY c.country
ORDER BY total_revenue DESC

--RANKING ANALYSIS
--WHICT 5 PRODUCT GENERATES THE HIEGHEST REVENUE
SELECT TOP 5
p.product_name,
SUM(f.sales_amount) AS total_sales
FROM  gold.dim_products p
LEFT JOIN gold.fact_sales f
ON p.product_key =f.product_key
GROUP BY p.product_name
ORDER BY total_sales DESC

--SLOVING SAME QUESTION USING WINDOW FUNCTION 
SELECT * FROM(
SELECT 
p.product_name,
SUM(f.sales_amount) AS total_sales,
RANK() OVER(ORDER BY SUM(f.sales_amount) DESC) AS ranks_products
FROM  gold.dim_products p
LEFT JOIN gold.fact_sales f
ON p.product_key =f.product_key
GROUP BY p.product_name)t
WHERE ranks_products<=5

-- What are the 5 worst-performing products in terms of sales?

SELECT TOP 5
p.product_name,
SUM(f.sales_amount) AS total_revenue
FROM gold.fact_sales f
LEFT JOIN gold.dim_products p
ON p.product_key = f.product_key
GROUP BY p.product_name
ORDER BY total_revenue
--SAME QUESTION WITH WINDOW FUNCTION
SELECT TOP 5
p.product_name,
SUM(f.sales_amount) AS total_revenue,
RANK() OVER(ORDER BY SUM(f.sales_amount) ASC) AS ranks_products
FROM gold.fact_sales f
LEFT JOIN gold.dim_products p
ON p.product_key = f.product_key
GROUP BY p.product_name

--FINDING 5 BEST  SUBCATEGORY 
SELECT TOP 5
p.subcategory,
SUM(f.sales_amount) AS total_revenue
FROM gold.fact_sales f
LEFT JOIN gold.dim_products p
ON p.product_key = f.product_key
GROUP BY p.subcategory
ORDER BY total_revenue
--SAME QUESTION WITH WINDOW FUNCTION
SELECT TOP 5
p.subcategory,
SUM(f.sales_amount) AS total_revenue,
RANK() OVER(ORDER BY SUM(f.sales_amount) ASC) AS ranks_products
FROM gold.fact_sales f
LEFT JOIN gold.dim_products p
ON p.product_key = f.product_key
GROUP BY p.subcategory

--FIND TOP 5 CUSTOMERS WHO HAVE GENERATES HIGHEST REVENUE
SELECT TOP 5
c.customer_key,
c.firstname,
c.lastname,
SUM(p.sales_amount) AS total_revenue
FROM gold.dim_customers c
LEFT JOIN gold.fact_sales p
ON c.customer_id=p.customer_id
GROUP BY c.customer_key,
c.firstname,
c.lastname
ORDER BY total_revenue DESC

--TOP 3 CUSTOMERS WITH FEW ORDERS
SELECT TOP 3
c.customer_key,
c.firstname,
c.lastname,
COUNT(DISTINCT order_number) AS total_orders 
FROM gold.dim_customers c
LEFT JOIN gold.fact_sales p
ON c.customer_id=p.customer_id
GROUP BY c.customer_key,
c.firstname,
c.lastname
ORDER BY total_orders ASC
